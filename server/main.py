# server/main.py
from flask import Flask, jsonify, Response
from flask_cors import CORS
from apscheduler.schedulers.background import BackgroundScheduler
import requests

# Import services
from services.latlong_service import get_device_data
from services.state_service import initialize_cache_db, poll_and_update_states, get_all_device_states
from utils.utils import save_icon_from_blob

# --- Flask App Initialization ---
app = Flask(__name__, static_folder='static')
CORS(app)

# --- Icon Configuration ---
hex_string = "0000010001002020000001002000A810000016000000280000002000000040000000010020000000000000000000232E0000232E00000000000000000000FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00C0F1FF3828CEFDD02ACEFDCCC4F1FF33FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00B7EFFE4127CFFDD200C6FDFF00C5FDFF2ACEFDCFBBF0FF3DFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FEFFFF00A8EDFE4F1ACEFDE000C7FDFF00C7FDFF00C7FDFF00C5FDFF1DCCFDDDADECFE4BFEFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFEFF029CEBFE5A13CEFDE700C9FDFF00C9FDFF00C8FDFF00C7FDFF00C7FDFF00C6FDFF16CAFDE5A1EAFE55FDFFFF01FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFEFF0296EAFE6110CFFDEC00CBFDFF00CBFDFF00CAFDFF00C9FDFF00C8FDFF00C8FDFF00C7FDFF00C6FDFF12C9FDE99CE8FE5CFDFEFF02FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFEFF0293EAFE630ED0FDEE00CCFDFF00CCFDFF00CCFDFF00CBFDFF00CAFDFF00C9FDFF00C9FDFF00C8FDFF00C7FDFF00C6FDFF10C9FDEC99E8FE5EFCFEFF01FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFFFF0296ECFF610ED2FEEE00CEFEFF00CEFDFF00CDFDFF00CCFDFF00CCFDFF00CBFDFF00CAFDFF00CAFDFF00C9FDFF00C8FDFF00C7FDFF00C6FDFF10C9FDEC9BE9FE5BFDFFFF01FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FEFFFF019DEEFF5910D3FEEC00D0FEFF00CFFEFF00CFFEFF00CEFEFF00CDFDFF00CDFDFF00CCFDFF00CBFDFF00CBFDFF00CAFDFF00C9FDFF00C8FDFF00C8FDFF00C6FDFF12CAFDE9A3EBFE54FEFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00ACF1FF4C14D6FEE600D1FEFF00D1FEFF00D0FEFF00D0FEFF00CFFEFF00CEFEFF00CDFDFF00CDFDFF00CCFDFF00CBFDFF00CBFDFF00CAFDFF00C9FDFF00C9FDFF00C8FDFF00C7FDFF17CBFDE4AFEDFE47FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00BDF4FF3B1DD9FEDD00D3FEFF00D3FEFF00D2FEFF00D1FEFF00D1FEFF00D0FEFF00CFFEFF00CEFEFF00CEFDFF00CDFDFF00CCFDFF00CCFDFF00CBFDFF00CAFDFF00C9FDFF00C9FDFF00C8FDFF00C7FDFF20CEFDD9C2F2FF36FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00D3F8FF272CDDFECD00D4FEFF00D4FEFF00D4FEFF00D3FEFF00D2FEFF00D1FEFF00D1FEFF00D0FEFF00CFFEFF00CEFEFF00CDFEFF00CDFDFF00CCFDFF00CCFDFF00CBFDFF00CAFDFF00CAFDFF00C9FDFF00C8FDFF00C7FDFF30D2FDC8D7F6FF23FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E7FBFF1445E2FEB200D6FEFF00D6FEFF00D5FEFF00D5FEFF00D4FEFF00D3FEFF00D2FEFF01D2FEFD0ED4FEEE1DD5FEDF25D6FED625D6FED61CD3FEDF0DD0FDEF01CDFDFD00CBFDFF00CBFDFF00CBFDFF00CAFDFF00C9FDFF00C8FDFF00C7FDFF4AD7FEADEAFAFF11FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F7FEFF066BE9FE8B01D8FEFD00D7FEFF00D7FEFF00D6FEFF00D5FEFF00D5FEFE22DAFED962E4FE979FEEFF5AC8F5FF32DEF9FF1EE6FAFF16E6FAFF16DDF8FF1FC6F4FF339DECFE5B5FDFFE9920D2FDDA00CBFDFE00CBFDFF00CAFDFF00C9FDFF00C9FDFF02C8FDFC71E0FE85F9FEFF04FFFFFF00FFFFFF00FFFFFF00FFFFFF009EF1FF5909DBFEF300D9FEFF00D8FEFF00D8FEFF00D7FEFF20DBFEDA85EBFF72DCF9FF1FFDFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FDFFFF01DAF8FF2182E6FE761ED1FDDC00CBFDFF00CAFDFF00CAFDFF00C9FDFF0BCAFDF1A4ECFE53FFFFFF00FFFFFF00FFFFFF00D2F9FF2622E0FED700DAFEFF00DAFEFF00D9FEFF01D8FEFD48E3FEAFCFF7FF2BFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00CCF5FF2E45DAFDB300CBFDFE00CBFDFF00CAFDFF00C9FDFF26D1FDD3D7F7FF22FFFFFF00F6FEFF075DE9FE9900DCFEFF00DCFEFF00DBFEFF00DAFEFE51E5FEA6E6FBFF14FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00E4FAFF174CDBFEAB00CBFDFF00CBFDFF00CAFDFF00C9FDFF64DEFE93F7FDFF05B2F5FF440EE0FEED00DDFEFF00DDFEFF00DBFEFF2EE2FECADDFAFF1DFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00D9F7FF212AD5FDCF00CBFDFF00CBFDFF00CAFDFF11CDFDEABAF0FE3E56EAFF9F00DFFFFF00DEFEFF00DDFEFF04DDFEF99AF1FF5CFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF0095EAFE6203CDFDFA00CCFDFF00CBFDFF00CAFDFF5EDEFE971BE3FFDD00E0FFFF00DFFFFF00DEFFFF22E2FED7E1FBFF19FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00DDF8FF1D1ED3FDDC00CCFDFF00CCFDFF00CBFDFF21D2FDD602E2FFF800E1FFFF00E0FFFF00DFFFFF44E7FFB5F7FEFF05FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F4FDFF083CDAFEBB00CDFDFF00CDFDFF00CCFDFF06CDFDF300E2FFFC00E2FFFF00E1FFFF00E0FFFF4DE9FFADFAFFFF03FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F7FEFF0543DCFEB400CEFEFF00CEFEFF00CDFDFF01CDFDF70DE5FFEC00E3FFFF00E2FFFF00E1FFFF33E7FFC5EFFDFF0DFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00ECFCFF102FD9FECB00CFFEFF00CFFEFF00CEFEFF12D1FDE637EAFFBF00E3FFFF00E3FFFF00E2FFFF0FE3FFEDC3F8FF36FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00BDF3FF3B0CD3FEF000D1FEFF00D0FEFF00CFFEFF3FDBFEB888F3FF6D03E5FFFB00E4FFFF00E3FFFF00E2FFFF5FEDFF98F8FEFF05FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F6FDFF0658E2FE9E00D2FEFF00D1FEFF00D1FEFF04D1FEF990EAFF66DFFCFF1B2FEAFFCA00E4FFFF00E4FFFF00E3FFFF0AE4FFF298F3FF5EFEFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FDFFFF0192EDFF6408D5FEF400D3FEFF00D2FEFF00D1FEFF34DAFEC4E4FAFF17FFFFFF00A3F6FF5509E6FFF300E5FFFF00E4FFFF00E3FFFF13E5FFE89AF4FF5CF9FEFF04FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F9FEFF0596EEFF6111D8FEEA00D5FEFF00D4FEFF00D3FEFF0BD4FEF1A9F0FF4FFFFFFF00FFFFFF00F8FEFF0574F1FF8203E6FFFA00E5FFFF00E4FFFF00E4FFFF0BE4FFF16AEEFF8CD8FBFF22FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00D6F9FF2467E8FE900AD8FEF300D6FEFF00D6FEFF00D5FEFF04D5FEF97AE8FE7CF9FEFF04FFFFFF00FFFFFF00FFFFFF00F1FEFF0B6EF1FF8806E6FFF700E5FFFF00E5FFFF00E4FFFF00E3FFFF22E6FFD875EFFF83C1F8FF38EBFDFF11FCFFFF02FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFFFF02EAFCFF12BFF6FF3A72EBFE8621DEFEDA00D8FEFF00D8FEFF00D7FEFF00D6FEFF07D7FEF574E8FE83F3FDFF0AFFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F5FEFF088CF4FF6A18E9FFE200E5FFFF00E5FFFF00E4FFFF00E3FFFF00E2FFFF0DE3FFEF2FE7FFCB55EBFFA571EEFF8881F0FF7981EFFF7A70EDFF8953E8FEA62EE3FECD0CDDFEF000DBFEFF00DAFEFF00DAFEFF00D9FEFF00D8FEFF1BDCFEE091EEFF65F6FEFF06FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FEFFFF00C5F9FF3454EEFFA40CE7FFF000E5FFFF00E4FFFF00E4FFFF00E3FFFF00E2FFFF00E1FFFF00E0FFFF00E0FFFF00DFFFFF00DEFFFF00DEFEFF00DDFEFF00DDFEFF00DCFEFF00DBFEFF00DAFEFF0EDCFEEE57E6FEA1C8F7FF31FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00F6FEFF07B9F8FF4062EFFF9623E9FFD806E5FFF700E4FFFF00E3FFFF00E2FFFF00E2FFFF00E1FFFF00E0FFFF00E0FFFF00DFFFFF00DEFFFF00DDFEFF07DEFEF724E1FED664E9FE93BCF5FF3DF7FEFF06FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FCFFFF01D9FBFF219FF5FF5964EFFF9436EAFFC317E6FFE207E3FFF400E2FFFC00E1FFFB07E1FFF318E3FFE136E6FFC265EBFF92A1F3FF57DAFAFF20FCFFFF01FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFF00FFFFFFFFFFFE7FFFFFFC3FFFFFF81FFFFFF00FFFFFE007FFFFC003FFFF8001FFFF0000FFFE00007FFC00003FF80FF01FF87FFE1FF0FFFF0FE3FFFFC7C7FFFFC3C7FFFFE38FFFFFF18FFFFFF18FFFFFF18FFFFFF18FFFFFF18FFFFFF1C7FFFFE3C7FFFFE3E3FFFFC7F1FFFF8FF87FFE1FFC1FF83FFF0000FFFFE007FFFFFFFFFF"
FENCE_ICON_BLOB = bytes.fromhex(hex_string)

def initialize_icons():
    """
    Saves all necessary icons when the server starts.
    """
    print("Initializing icons...")
    save_icon_from_blob(FENCE_ICON_BLOB, filename="fence_icon.png")

# --- API Endpoints ---
@app.route('/api/map-image', methods=['GET'])
def map_image_proxy():
    """
    Acts as a proxy to fetch the map image from the local ESRI server.
    """
    image_url = "https://esri.tsliss.local/server/services/Data/MapServer/WMSServer?request=GetMap&styles=&version=1.1.1&height=400&width=400&srs(crs)=CRS:84&bbox=86.181563,22.766676,86.218643,22.804039&layers=0,7&format=image/png"
    try:
        # Use verify=False if the local server has a self-signed certificate
        r = requests.get(image_url, stream=True, verify=False)
        r.raise_for_status() # Raise an exception for bad status codes
        return Response(r.iter_content(chunk_size=1024), content_type=r.headers['Content-Type'])
    except requests.exceptions.RequestException as e:
        print(f"Error fetching map image: {e}")
        return "Error fetching map image", 500

@app.route('/api/devices', methods=['GET'])
def get_devices_endpoint():
    """
    Endpoint for lat/long and color priority data.
    """
    devices = get_device_data()
    if isinstance(devices, dict) and 'error' in devices:
        return jsonify(devices), 500
    return jsonify(devices)

@app.route('/api/device-states', methods=['GET'])
def get_device_states_endpoint():
    """
    New endpoint to get the cached effective states of all devices.
    """
    device_states = get_all_device_states()
    return jsonify(device_states)

# --- Main Execution Block ---
if __name__ == '__main__':
    # Initialize icons
    initialize_icons()
    
    # Initialize the SQLite cache database
    initialize_cache_db()
    
    # Set up and start the background scheduler
    scheduler = BackgroundScheduler()
    scheduler.add_job(func=poll_and_update_states, trigger="interval", seconds=60)
    scheduler.start()
    
    # Run the Flask app
    app.run(debug=True, port=5000, use_reloader=False)